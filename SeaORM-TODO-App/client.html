<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building The TODO TCP Client - SeaORM-TODO-App</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="tcp-server.html"><strong aria-hidden="true">2.</strong> Building The TCP Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tables.html"><strong aria-hidden="true">2.1.</strong> Creating Tables</a></li><li class="chapter-item expanded "><a href="server.html"><strong aria-hidden="true">2.2.</strong> Building Server Connections and Responses</a></li></ol></li><li class="chapter-item expanded "><a href="client.html" class="active"><strong aria-hidden="true">3.</strong> Building The TODO TCP Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="utils.html"><strong aria-hidden="true">3.1.</strong> Formating Utilities</a></li><li class="chapter-item expanded "><a href="remote-db.html"><strong aria-hidden="true">3.2.</strong> Remote Database Operations</a></li><li class="chapter-item expanded "><a href="stdout.html"><strong aria-hidden="true">3.3.</strong> Reading User Input</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SeaORM-TODO-App</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/SeaQL/sea-orm-tutorial" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/SeaQL/sea-orm-tutorial/edit/master/SeaORM-TODO-App/book/src/client.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-the-todo-tcp-client"><a class="header" href="#building-the-todo-tcp-client">Building The TODO TCP Client</a></h1>
<p>This chapter focuses on creating the TCP client. Switch to the <code>TODO-Client</code> directory in the workspace.</p>
<h4 id="configuration"><a class="header" href="#configuration">Configuration</a></h4>
<p>Add the necessary dependencies to create the client.</p>
<pre><code class="language-sh">$ cargo add async-std --features attributes

$ cargo add anyhow

$ cargo add bincode

$ cargo add serde --features derive

$ cargo add serde_json
</code></pre>
<p><code>bincode</code> crate will be used to prepare the bytes of  <code>Command</code> to send over the wire. <code>serde_json</code> crate will serialize the TODO list data structure that contains queued and completed TODOs into a JSON string for remote storage in the PostgreSQL database.</p>
<p>The TCP client will also store local cache, simulating a real world setup especially for a desktop or mobile client. SQLite will be the preferred database for this tutorial due to it's popularity. A command line frontend and a TCP stream will be used to keep the tutorial simple and easy to port to other domains like mobile device connection, desktop clients or HTTP clients if you wish to explore other domains.</p>
<p>Add <code>sea-orm</code> crate with the SQLite features enabled for the local persistent cache. The  runtime features <code>runtime-async-std-rustls</code> are used since the async library for this client is <code>async-std</code> crate.</p>
<pre><code class="language-sh">$ cargo add sea-orm  --features &quot;runtime-async-std-rustls sqlx-sqlite macros&quot; --no-default-features
</code></pre>
<p>Modify the main function in  <code>src/main.rs</code> to use async-std</p>
<pre><code class="language-rust no_run noplayground">- fn main() {
-     println!(&quot;Hello, world!&quot;);
- }

+ #[async_std::main]
+ async fn main() -&gt; anyhow::Result&lt;()&gt;{
+     Ok(())
+ }
</code></pre>
<p>Next, create a <code>.env</code> file in the current directory. This will contain the database configuration.</p>
<p><code>File: TODO-Client/.env</code></p>
<pre><code class="language-sh">DATABASE_URL=sqlite://my_todos.db
</code></pre>
<p>Here, the <code>sqlite</code> URL does not take a <code>username</code>, <code>password</code> and <code>IP</code> since SQLite does not have have a server, just the database name <code>my_todos.db</code>.</p>
<p>Create an empty SQLite database using the command:</p>
<pre><code class="language-sh">$ sqlite3 my_todos.db &quot;VACUUM;&quot;
</code></pre>
<p>The <code>&quot;VACUUM;&quot;</code> part of the command will ensure the created database is not just held in memory but also persisted to the file system even though it is empty.</p>
<h4 id="local-sqlite-database-operations"><a class="header" href="#local-sqlite-database-operations">Local SQLite Database Operations</a></h4>
<p>Create a file <code>src/db_ops.rs</code> which will contain functions to perform database operations.</p>
<pre><code class="language-rust no_run noplayground">use async_std::{
    io::{ReadExt, WriteExt},
    net::TcpStream,
};
use sea_orm::{
    sea_query::{Alias, ColumnDef, Table},
    ActiveModelTrait, ConnectionTrait, Database, DatabaseConnection, EntityTrait, Set,
};

pub async fn database_config() -&gt; Result&lt;DatabaseConnection, sea_orm::DbErr&gt; {
    // Read the database environment from the `.env` file
    let env_database_url = include_str!(&quot;../.env&quot;).trim();
    // Split the env url
    let split_url: Vec&lt;&amp;str&gt; = env_database_url.split(&quot;=&quot;).collect();
    // Get item with the format `database_backend://username:password@localhost/database`
    let database_url = split_url[1];

    Database::connect(database_url).await
}


pub async fn create_todo_table(db: &amp;DatabaseConnection) -&gt; anyhow::Result&lt;()&gt; {
    let database_backend = db.get_database_backend();
    // Create the `todos` table
    let todos_table = Table::create()
        .table(Alias::new(&quot;todo_list&quot;))
        .if_not_exists()
        .col(
            ColumnDef::new(Alias::new(&quot;todo_id&quot;))
                .integer()
                .primary_key()
                .not_null()
                .auto_increment(),
        )
        .col(
            ColumnDef::new(Alias::new(&quot;todo_name&quot;))
                .string()
                .unique_key()
                .not_null(),
        )
        .col(ColumnDef::new(Alias::new(&quot;quantity&quot;)).string().not_null())
        .col(ColumnDef::new(Alias::new(&quot;status&quot;)).boolean().not_null())
        .to_owned();
    let create_table_op = db.execute(database_backend.build(&amp;todos_table)).await;

    // Executing the SQL query to create the `todos` table in SQLite
    let create_table_op = db.execute(database_backend.build(&amp;todos_table)).await;
    // Print the result in a user friendly way
    println!(
        &quot;`CREATE TABLE todo_list` {:?}&quot;,
        match create_table_op {
            Ok(_) =&gt; &quot;Operation Successful&quot;.to_owned(),
            Err(e) =&gt; format!(&quot;Unsuccessful - Error {:?}&quot;, e),
        }
    );

    Ok(())
}

</code></pre>
<p><code>database_config()</code> reads the <code>.env</code> file and parses the database URL, creates a database connection with the URL using <code>Database::connect()</code> and then returns a <code>DatabaseConnection</code>.</p>
<p><code>create_todo_table()</code> when invoked will create a new <code>todo_list</code> table in the local SQLite database specified by the URL.</p>
<p>Import the <code>db_ops</code> module into <code>src/main.rs</code>	 and call both functions.</p>
<pre><code class="language-rust no_run noplayground">+ mod db_ops;
+ pub use db_ops::*;

#[async_std::main]
async fn main() -&gt; anyhow::Result&lt;()&gt; {
+	let db = database_config().await?;
+	create_todo_table(&amp;db).await?;
    
    Ok(())
}

</code></pre>
<p>Next is to auto-generate the <code>Model</code>, <code>ActiveModel</code> , <code>Entity</code>, etc... using the <code>sea-orm-cli</code> and pass in <code>--with-serde both</code> feature flag to auto-generate <code>serde::Serialize</code> and <code>serde::Deserialize</code> on the Entity.</p>
<pre><code class="language-sh">$ sea-orm-cli generate entity -o src/todo_list_table -t todo_list --with-serde both
</code></pre>
<p>This will create a new directory <code>todo_list_table</code> in the <code>src/</code> directory. </p>
<p>Open the <code>src/todo_list_table/prelude.rs</code> file and import the <code>Entity</code>, <code>Model</code> and <code>ActiveModel</code> using friendly names.</p>
<p><code>File:src/todo_list_table/prelude.rs</code></p>
<pre><code class="language-rust no_run noplayground">//! SeaORM Entity. Generated by sea-orm-codegen 0.6.0

- pub use super::todo_list::Entity as TodoList;

+ pub use super::todo_list::{
+     ActiveModel as MyTodosActiveModel, Column as MyTodosColumn, Entity as MyTodos,
+     Model as MyTodosModel, PrimaryKey as MyTodosPrimaryKey, Relation as MyTodosRelation,
+ };

</code></pre>
<p>Import the modules to the <code>src/main.rs</code> file</p>
<pre><code class="language-rust no_run noplayground">  mod db_ops;
+ mod todo_list_table;

  pub use db_ops::*;
+ pub use todo_list_table::prelude::*;

#[async_std::main]
async fn main() -&gt; anyhow::Result&lt;()&gt; {
    let db = database_config().await?;
    create_todo_table(&amp;db).await?;

    Ok(())
}

</code></pre>
<h4 id="common-data-structures"><a class="header" href="#common-data-structures">Common Data Structures</a></h4>
<p>To perform more database operations, create a <code>common.rs</code>  file in the <code>src</code> directory. This file will contain common data structures for use throughout database operations and TCP connections.</p>
<p><code>File: src/common.rs</code></p>
<pre><code class="language-rust no_run noplayground">use crate::MyTodosModel;
use serde::{Deserialize, Serialize}; // The commands to use to perform CRUD operations on PostgreSQL

// The commands to use to perform CRUD operations on PostgreSQL
#[derive(Debug, Serialize, Deserialize)]
pub enum Command {
    Store { username: String, todo_list: String },
    UpdateTodoList { username: String, todo_list: String },
    Get(String),
    CreateUser(String),
    ListFruits,
}

//  The structure for a TodoList
#[derive(Debug, Serialize, Default, Deserialize)]
pub struct TodoList {
    pub queued: Vec&lt;MyTodosModel&gt;,
    pub completed: Vec&lt;MyTodosModel&gt;,
}

</code></pre>
<p>The enum <code>Command</code> mirrors the <code>Command</code> created in the previous chapter in the <code>TODO-Server/src/tcp_api.rs</code> file.</p>
<p>The <code>TodoList</code> struct contains the <code>Model</code>s <code>MyTodoModel</code> sorted either as <code>queued</code> which are TODOs not done or <code>completed</code> which are <code>TODO</code>s that are done.</p>
<p>Import this file to the <code>src/main.rs</code> file</p>
<pre><code class="language-rust no_run noplayground">+ mod common;
  mod db_ops;
  mod todo_list_table;

+ pub use common::*;
  pub use db_ops::*;
  pub use todo_list_table::prelude::*;

#[async_std::main]
async fn main() -&gt; anyhow::Result&lt;()&gt; {
    let db = database_config().await?;
    create_todo_table(&amp;db).await?;

    Ok(())
}

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="server.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="utils.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="server.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="utils.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
